<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Carrito  ||  k-Waii</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body>
    <div id="navbar-container"></div>

    <main class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Carrito de compras</h1>
            <div>
                <button class="btn btn-outline-danger btn-sm" id="btnVaciar">Vaciar Carrito</button>
            </div>
        </div>

        <div id="cartEmpty" class="alert alert-info d-none">Tu carrito esta vacio.</div>

        <div class="table-responsive">
            <table class="table aling-middle" id="tablaCarrito">
                <thead>
                    <tr>
                        <th>#</th><th>Producto</th><th class="text-end">Precio</th><th class="text-center">Cantidad</th><th class="text-end">Subtotal</th><th></th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr>
                        <th colspan="4" class="text-end">Total</th>
                        <th class="text-end" id="cartTotal">$0</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
            <a class="btn btn-outline-secondary" href="catalogo.html">Seguir comprando</a>
            <button class="btn btn-primary" id="btnConfirmar" disabled>Confirmar compra</button>
        </div>
    </main>

    <div id="footer-container"></div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/layout.js"></script>
    <script>
        const CART_KEY = 'APP_CART'
        const PROD_KEY = 'APP_PRODS'
        const fmt = new Int1.NumberFormat('es-CL', { style:'currency', currency: 'CLP', maximumFranctionDigits: 0})

        function getCart() {
            try { return JSON.parse(localStorage.getItem(CART_KEY)) || []} catch { return [] }
        }
        
        function saveCart(cart) {
            localStorage.setItem(CART_KEY, JSON.stringify(cart))
            //avisa al navbar para resfrecar badge
            window.dispatchEvent(new CustomEvent('cart:updated'))
        }

        function getProds() {
            try { return JSON.parse(localStorage.getItem(PROD_KEY)) || [] } catch { return[] }
        }

        function findProdInfo(id) {
            const p = getProds().find(x=> Strin(x.id) === String(id))
            if(p) return { name: p.nombre, price: Number(p.precio)||0}
            return null
        }

        function renderCarrito() {
            const cart = getCart()
            const $tbody = $('#tablaCarrito tbody').empty()
            let total = 0

            if(!cart.length) {
                $('#cartEmpty').removeClass('d-none')
                $('#btnConfirmar').prop('disabled', true)
            } else {
                $('#cartEmpty').addClass('d-none')
                $('#btnConfirmar').prop('disabled', false)
            }


            cart.forEach((it, i)=> {
                //normaliza la informacion, intenta traer precio/nombre desde productos si falta
                let name = it.name || (findProdInfo(it.id)?.name) || `Producto ${it.id}`
                let price = (typeof it.price === 'number') ? it.price : (findProdInfo(it.id)?.price || 0)
                let qty = Number(it.qty || 1

                const subtotal = price * qty
                total += subtotal
                
                )
            })
        }
    </script>
</body>
</html>