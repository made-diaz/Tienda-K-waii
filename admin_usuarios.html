<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Admin Usuarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="d-flex flex-column min-vh-100">
<div id="navbar-container"></div>

<main class="container py-5 flex-grow-1">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Administración de usuarios</h1>
        <button class="btn btn-success btn-sm" id="btnNuevoUsuario">+ Nuevo</button>
    </div>

    <div class="table-responsive">
        <table class="table table-striped" id="tablaUsuarios">
            <thead>
            <tr>
                <th>#</th><th>Nombre</th><th>Email</th><th>Rol</th><th>Acciones</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</main>

<div id="footer-container"></div>

<!-- Modal usuario -->
<div class="modal fade" id="usuarioModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Usuario</h5></div>
            <div class="modal-body">
                <form id="usuarioForm">
                    <input type="hidden" id="usrEmailOld">
                    <div class="mb-3"><label class="form-label">Nombre</label><input id="usrNombre" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Correo</label><input id="usrCorreo" type="email" class="form-control" required></div>
                    <div class="mb-3">
                        <label class="form-label">Rol</label>
                        <select id="usrRol" class="form-select">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3"><label class="form-label">Contraseña</label><input id="usrPass" type="password" class="form-control" required></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" id="btnGuardarUsr">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/layout.js"></script>
<script>
    function getUsers(){ return JSON.parse(localStorage.getItem('APP_USERS'))||[]; }
    function saveUsers(u){ localStorage.setItem('APP_USERS', JSON.stringify(u)); }

    function renderUsuarios(){
        const users = getUsers();
        const $tb = $("#tablaUsuarios tbody").empty();
        users.forEach((u,i)=>{
            $tb.append(`
        <tr>
          <td>${i+1}</td>
          <td>${u.name}</td>
          <td>${u.email}</td>
          <td>${u.role}</td>
          <td>
            <button class="btn btn-sm btn-primary editar" data-email="${u.email}">Editar</button>
            <button class="btn btn-sm btn-danger eliminar" data-email="${u.email}">Eliminar</button>
          </td>
        </tr>
      `);
        });
    }

    $(function(){
        const user = AuthStore.getCurrentUser();
        if(!user){ location.href="login.html"; return; }
        if(user.role!=="admin"){ location.href="index.html"; return; }
        Layout.loadPartials();

        renderUsuarios();

        $("#btnNuevoUsuario").on("click", ()=>{
            $("#usrEmailOld").val("");
            $("#usuarioForm")[0].reset();
            new bootstrap.Modal("#usuarioModal").show();
        });

        $("#btnGuardarUsr").on("click", ()=>{
            const oldEmail = $("#usrEmailOld").val();
            let users = getUsers();

            if(oldEmail){
                const idx = users.findIndex(u=>u.email===oldEmail);
                users[idx] = {
                    name: $("#usrNombre").val(),
                    email: $("#usrCorreo").val(),
                    role: $("#usrRol").val(),
                    pass: $("#usrPass").val()
                };
            }else{
                users.push({
                    name: $("#usrNombre").val(),
                    email: $("#usrCorreo").val(),
                    role: $("#usrRol").val(),
                    pass: $("#usrPass").val()
                });
            }
            saveUsers(users);
            renderUsuarios();
            bootstrap.Modal.getInstance(document.getElementById("usuarioModal")).hide();
        });

        $(document).on("click",".editar",function(){
            const u = getUsers().find(x=>x.email===$(this).data("email"));
            $("#usrEmailOld").val(u.email);
            $("#usrNombre").val(u.name);
            $("#usrCorreo").val(u.email);
            $("#usrRol").val(u.role);
            $("#usrPass").val(u.pass);
            new bootstrap.Modal("#usuarioModal").show();
        });

        $(document).on("click",".eliminar",function(){
            let users = getUsers().filter(x=>x.email!=$(this).data("email"));
            saveUsers(users);
            renderUsuarios();
        });
    });
</script>
</body>
</html>
