<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Catálogo | Mi Tienda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="assets/image/logoSinFondo.png" type="image/x-icon">
</head>
<body class="d-flex flex-column min-vh-100">
<div id="navbar-container"></div>

<main class="container py-5 flex-grow-1">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Catálogo</h1>
        <a id="btnLight" class="btn btn-outline-secondary btn-sm" href="index.html">Volver al inicio</a>
    </div>

    <div id="catalogInfo" class="alert alert-info d-none"></div>
    <div id="catalogoGrid"></div> <!-- ahora alojará secciones completas -->
</main>

<div id="footer-container"></div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/layout.js"></script>
<script>
    const PROD_KEY = "APP_PRODS";
    const CART_KEY = "APP_CART";
    const fmt = new Intl.NumberFormat('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 });

    function getProds(){ try { return JSON.parse(localStorage.getItem(PROD_KEY))||[]; } catch { return []; } }
    function getCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY))||[]; } catch { return []; } }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); window.dispatchEvent(new CustomEvent('cart:updated')); }

    // Escapa texto para insertar en HTML
    function escapeHtml(text){
        if(text === null || text === undefined) return '';
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    // Etiqueta legible para una categoria normalizada
    function categoryLabel(cat){
        if(!cat) return 'Sin categoría';
        const c = cat.toLowerCase();
        if(c === 'bebidas') return 'Bebidas';
        if(c === 'snack' || c === 'snacks') return 'Snacks';
        if(c === 'fideos' || c === 'fideos instantaneos' || c === 'fideos_instantaneos') return 'Fideos Instantáneos';
        return cat.charAt(0).toUpperCase() + cat.slice(1);
    }

    function normalizeCategory(cat){
        if(!cat) return '';
        return String(cat).trim().toLowerCase();
    }

    function renderCatalogo(){
        const prods = getProds();
        const $grid = $('#catalogoGrid').empty();
        const $info = $('#catalogInfo');

        if(!prods.length){
            $info.removeClass('d-none').text('Aún no hay productos. Añádelos en el panel de administración.');
            return;
        } else {
            $info.addClass('d-none').text('');
        }

        // Agrupar por categoria (normalizada)
        const groups = prods.reduce((acc, p) => {
            const cat = normalizeCategory(p.categoria); // usa p.categoria
            const key = cat || 'otros';
            if(!acc[key]) acc[key] = [];
            acc[key].push(p);
            return acc;
        }, {});

        // Orden deseado de secciones
        const order = ['bebidas','snack','fideos','otros'];

        order.forEach(sectionKey => {
            const items = groups[sectionKey] || [];
            if(!items.length) return; // salta secciones vacías

            // Título de sección
            let titulo = '';
            if(sectionKey === 'bebidas') titulo = 'Bebidas';
            else if(sectionKey === 'snack') titulo = 'Snacks';
            else if(sectionKey === 'fideos') titulo = 'Fideos Instantáneos';
            else titulo = 'Otros productos';

            // Append sección (título + row)
            const sectionId = `section-${sectionKey}`;
            $grid.append(`
          <section id="${sectionId}" class="mb-5">
            <h2 class="h4 mb-3">${escapeHtml(titulo)}</h2>
            <div class="row g-4" id="${sectionId}-row"></div>
          </section>
        `);

            const $row = $(`#${sectionId}-row`);

            items.forEach(p=>{
                const price = Number(p.precio) || Number(p.price) || 0;
                const imgSrc = p.img || `https://picsum.photos/seed/prod${p.id}/600/400`;
                const catBadge = p.categoria ? `<span class="badge bg-secondary text-capitalize">${escapeHtml(p.categoria)}</span>` : '';
                $row.append(`
            <div class="col-12 col-sm-6 col-lg-4">
              <div class="card h-100">
                <img src="${escapeHtml(imgSrc)}" class="card-img-top" alt="${escapeHtml(p.nombre)}" style="height:220px;object-fit:cover;">
                <div class="card-body d-flex flex-column">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">${escapeHtml(p.nombre)}</h5>
                    ${catBadge}
                  </div>
                  <p class="text-muted small mb-1">Stock: ${escapeHtml(p.stock)}</p>
                  <p class="mb-3">Precio: <strong>${fmt.format(price)}</strong></p>
                  <div class="mt-auto d-flex justify-content-between align-items-center">
                    <a class="btn btn-outline-secondary btn-sm" href="carrito.html">Ver carrito</a>
                    <button id="btnDark" class="btn btn-primary btn-sm addToCart" data-id="${p.id}" data-name="${escapeHtml(p.nombre)}" data-price="${price}">Agregar</button>
                  </div>
                </div>
              </div>
            </div>
          `);
            });
        });

        // Si había categorías fuera del orden (por ejemplo 'otrotexto'), las renderizamos después
        Object.keys(groups).forEach(k=>{
            if(order.includes(k)) return;
            const items = groups[k];
            if(!items || !items.length) return;
            const titulo = categoryLabel(k);
            const sectionId = `section-${k}`;
            $grid.append(`
          <section id="${sectionId}" class="mb-5">
            <h2 class="h4 mb-3">${escapeHtml(titulo)}</h2>
            <div class="row g-4" id="${sectionId}-row"></div>
          </section>
        `);
            const $row = $(`#${sectionId}-row`);
            items.forEach(p=>{
                const price = Number(p.precio) || Number(p.price) || 0;
                const imgSrc = p.img || `https://picsum.photos/seed/prod${p.id}/600/400`;
                const catBadge = p.categoria ? `<span class="badge bg-secondary text-capitalize">${escapeHtml(p.categoria)}</span>` : '';
                $row.append(`
            <div class="col-12 col-sm-6 col-lg-4">
              <div class="card h-100">
                <img src="${escapeHtml(imgSrc)}" class="card-img-top" alt="${escapeHtml(p.nombre)}" style="height:220px;object-fit:cover;">
                <div class="card-body d-flex flex-column">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">${escapeHtml(p.nombre)}</h5>
                    ${catBadge}
                  </div>
                  <p class="text-muted small mb-1">Stock: ${escapeHtml(p.stock)}</p>
                  <p class="mb-3">Precio: <strong>${fmt.format(price)}</strong></p>
                  <div class="mt-auto d-flex justify-content-between align-items-center">
                    <a id = "btnLight" class="btn btn-outline-secondary btn-sm" href="carrito.html">Ver carrito</a>
                    <button class="btn btn-primary btn-sm addToCart" data-id="${p.id}" data-name="${escapeHtml(p.nombre)}" data-price="${price}">Agregar</button>
                  </div>
                </div>
              </div>
            </div>
          `);
            });
        });
    }

    //modifiacion madeleyne
    function renderOffcanvasCart() {
        const cart = getCart();
        const $body = $('#offcanvasCartBody').empty();
        let total = 0;

        if (!cart.length) {
            $body.append('<div class="alert alert-info">Tu carrito está vacío.</div>');
            $('#btnConfirmarCanvas').prop('disabled', true);
            $('#offcanvasCartTotal').text(fmt.format(0));
            return;
        } else {
            $('#btnConfirmarCanvas').prop('disabled', false);
        }

        cart.forEach(item => {
            const prod = getProds().find(p => p.id === item.id) || {};
            const name = item.name || prod.nombre || 'Producto';
            const price = item.price || prod.precio || 0;
            const img = prod.img || `https://picsum.photos/seed/prod${item.id}/100/100`;
            const qty = item.qty || 1;
            const subtotal = price * qty;
            total += subtotal;

            $body.append(`
            <div class="d-flex align-items-center mb-3 border-bottom pb-2">
              <img src="${escapeHtml(img)}" class="rounded me-2" width="60" height="60" alt="${escapeHtml(name)}">
              <div class="flex-grow-1">
                <div class="fw-bold">${escapeHtml(name)}</div>
                <small class="text-muted">${fmt.format(price)} x <span class="item-qty">${qty}</span></small>
                <div class="mt-1">
                  <button class="btn btn-sm btn-outline-secondary btnMinus" data-id="${item.id}">-</button>
                  <button class="btn btn-sm btn-outline-secondary btnPlus" data-id="${item.id}">+</button>
                </div>
              </div>
              <div class="text-end fw-bold">${fmt.format(subtotal)}</div>
            </div>
          `);
        });

        $('#offcanvasCartTotal').text(fmt.format(total));
    }

    //fin modificacion

    $(function(){
        // Guard: obliga a login si entran directo por URL
        const user = AuthStore.getCurrentUser();
        if(!user){ location.href='login.html'; return; }

        Layout.loadPartials();
        renderCatalogo();

        $(document).on('click', '.addToCart', function(){
            const id = Number($(this).data('id'));
            const name = $(this).data('name');
            const price = Number($(this).data('price'))||0;
            const cart = getCart();
            const found = cart.find(i=>i.id===id);
            if(found){ found.qty = (found.qty||1)+1; }
            else { cart.push({id, name, price, qty:1}); }
            saveCart(cart);

            renderOffcanvasCart();
            const offcanvas = new bootstrap.Offcanvas('#offcanvasCart');
            offcanvas.show();
        });

        // Incrementar cantidad
        $(document).on('click', '.btnPlus', function(){
            const id = Number($(this).data('id'));
            const cart = getCart();
            const item = cart.find(i => i.id === id);
            if(item){
                item.qty++;
                saveCart(cart);
                renderOffcanvasCart();
            }
        });

        // Disminuir cantidad
        $(document).on('click', '.btnMinus', function(){
            const id = Number($(this).data('id'));
            let cart = getCart();
            const item = cart.find(i => i.id === id);
            if(item){
                item.qty--;
                if(item.qty <= 0){
                    cart = cart.filter(i => i.id !== id);
                }
                saveCart(cart);
                renderOffcanvasCart();
            }
        });


        $('#btnConfirmarCanvas').on('click', () => {
            const totalText = $('#offcanvasCartTotal').text();
            sessionStorage.setItem('LAST_ORDER_TOTAL', totalText);
            saveCart([]); // vacía el carrito
            location.href = 'gracias.html'; // redirige a la página de agradecimiento
        });

    });
</script>

<!--Madeleyne-->
<!-- Offcanvas Carrito -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCart">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">Carrito</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body" id="offcanvasCartBody">
        <!-- Aquí se renderizan los productos -->
    </div>
    <div class="p-3 border-top">
        <div class="d-flex justify-content-between">
            <strong>Total:</strong>
            <span id="offcanvasCartTotal">$0</span>
        </div>
        <button class="btn btn-primary w-100 mt-2" id="btnConfirmarCanvas" disabled>
            Confirmar compra
        </button>
    </div>
</div>

</body>
</html>
