<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Catálogo | Mi Tienda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div id="navbar-container"></div>

<main class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Catálogo</h1>
        <a class="btn btn-outline-secondary btn-sm" href="index.html">Volver al inicio</a>
    </div>

    <div id="catalogInfo" class="alert alert-info d-none"></div>
    <div class="row g-4" id="catalogoGrid"></div>
</main>

<div id="footer-container"></div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/layout.js"></script>
<script>
    const PROD_KEY = "APP_PRODS";
    const CART_KEY = "APP_CART";
    const fmt = new Intl.NumberFormat('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 });

    function getProds(){ try { return JSON.parse(localStorage.getItem(PROD_KEY))||[]; } catch { return []; } }
    function getCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY))||[]; } catch { return []; } }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); window.dispatchEvent(new CustomEvent('cart:updated')); }

    function renderCatalogo(){
        const prods = getProds();
        const $grid = $('#catalogoGrid').empty();
        const $info = $('#catalogInfo');

        if(!prods.length){
            $info.removeClass('d-none').text('Aún no hay productos. Añádelos en el panel de administración.');
            return;
        } else {
            $info.addClass('d-none').text('');
        }

        prods.forEach(p=>{
            const price = Number(p.precio)||0;
            const imgSrc = p.img || `https://picsum.photos/seed/prod${p.id}/600/400`;
            $grid.append(`
          <div class="col-12 col-sm-6 col-lg-4">
            <div class="card h-100">
              <img src="${imgSrc}" class="card-img-top" alt="${p.nombre}">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">${p.nombre}</h5>
                <p class="text-muted small">Stock: ${p.stock}</p>
                <p class="mb-3">Precio: <strong>${fmt.format(price)}</strong></p>
                <div class="mt-auto d-flex justify-content-between align-items-center">
                  <a class="btn btn-outline-secondary btn-sm" href="carrito.html">Ver carrito</a>
                  <button class="btn btn-primary btn-sm addToCart" data-id="${p.id}" data-name="${p.nombre}" data-price="${price}">Agregar</button>
                </div>
              </div>
            </div>
          </div>
        `);
        });
    }

    $(function(){
        // Guard: obliga a login si entran directo por URL
        const user = AuthStore.getCurrentUser();
        if(!user){ location.href='login.html'; return; }

        Layout.loadPartials();
        renderCatalogo();

        $(document).on('click', '.addToCart', function(){
            const id = Number($(this).data('id'));
            const name = $(this).data('name');
            const price = Number($(this).data('price'))||0;
            const cart = getCart();
            const found = cart.find(i=>i.id===id);
            if(found){ found.qty = (found.qty||1)+1; }
            else { cart.push({id, name, price, qty:1}); }
            saveCart(cart);
        });
    });
</script>
</body>
</html>
