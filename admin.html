<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Admin Productos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="assets/image/logoSinFondo.png" type="image/x-icon">
</head>
<body class="d-flex flex-column min-vh-100">
<div id="navbar-container"></div>

<main class="container py-5 flex-grow-1">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Administración de productos</h1>
        <button class="btn btn-success btn-sm" id="btnNuevo">+ Nuevo</button>
    </div>

    <div class="table-responsive">
        <table class="table table-striped align-middle" id="tablaProductos">
            <thead>
            <tr>
                <th>#</th><th>Producto</th><th>Categoria</th><th>Precio</th><th>Stock</th><th>Acciones</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</main>

<div id="footer-container"></div>

<!-- Modal producto -->
<div class="modal fade" id="productoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Producto</h5></div>
            <div class="modal-body">
                <form id="productoForm" novalidate>
                    <input type="hidden" id="prodId">

                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input id="prodNombre" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Precio</label>
                        <input id="prodPrecio" type="number" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Categoria</label>
                        <!-- Mantengo input para flexibilidad; se normaliza al guardar -->
                        <input id="prodCategoria" class="form-control" required placeholder="ej: bebidas">
                        <div class="form-text">Usa nombres estandarizados (ej: bebidas, snack, fideos)</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Stock</label>
                        <input id="prodStock" type="number" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Imagen (JPG/PNG, máx ~1MB)</label>
                        <input id="prodImg" type="file" accept="image/*" class="form-control">
                        <div class="form-text">Opcional. Si no subes, se usará una imagen por defecto.</div>
                    </div>

                    <div class="mb-2">
                        <img id="prodPreview" src="" alt="Previsualización" class="img-fluid rounded border d-none">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" id="btnGuardarProd">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/layout.js"></script>
<script>
    const PROD_KEY = "APP_PRODS";
    function getProds(){ try { return JSON.parse(localStorage.getItem(PROD_KEY))||[]; } catch { return []; } }
    function saveProds(p){ localStorage.setItem(PROD_KEY, JSON.stringify(p)); }

    // Formato monetario para tabla (opcional)
    const fmt = new Intl.NumberFormat('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 });

    // ===== Imagen: lectura/compresión =====
    let currentImgData = ""; // DataURL actual del modal (solo si sube nueva imagen)

    function readFileAsDataURL(file){
        return new Promise((res, rej)=>{
            const fr = new FileReader();
            fr.onload = () => res(fr.result);
            fr.onerror = rej;
            fr.readAsDataURL(file);
        });
    }

    // Reescala máximo 800px, calidad 0.85
    async function compressImage(dataURL, maxSize=800, mime='image/jpeg', quality=0.85){
        return new Promise((res)=>{
            const img = new Image();
            img.onload = ()=>{
                const scale = Math.min(maxSize/img.width, maxSize/img.height, 1);
                const w = Math.round(img.width * scale);
                const h = Math.round(img.height * scale);
                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                res(canvas.toDataURL(mime, quality));
            };
            img.src = dataURL;
        });
    }

    // ===== Render tabla (ahora mostrando categoria) =====
    function renderTabla(){
        const prods = getProds();
        const $tbody = $("#tablaProductos tbody").empty();
        prods.forEach((p,i)=>{
            const thumb = p.img || `https://picsum.photos/seed/prod${p.id}/60/40`;
            const categoria = p.categoria ? `<span class="badge bg-secondary text-capitalize">${escapeHtml(p.categoria)}</span>` : '-';
            $tbody.append(`
          <tr>
            <td>${i+1}</td>
            <td class="d-flex align-items-center gap-2">
              <img src="${thumb}" style="width:60px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #ddd">
              <span>${escapeHtml(p.nombre)}</span>
            </td>
            <td>${categoria}</td>
            <td>${fmt.format(Number(p.precio)||0)}</td>
            <td>${Number(p.stock)||0}</td>
            <td>
              <button class="btn btn-sm btn-primary editar" data-id="${p.id}">Editar</button>
              <button class="btn btn-sm btn-danger eliminar" data-id="${p.id}">Eliminar</button>
            </td>
          </tr>
        `);
        });
    }

    // Pequeña función para escapar texto y evitar inyección al insertar HTML
    function escapeHtml(text){
        if(text === null || text === undefined) return '';
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    $(function(){
        // Guards
        const user = AuthStore.getCurrentUser();
        if(!user){ location.href="login.html"; return; }
        if(user.role!=="admin"){ location.href="index.html"; return; }

        Layout.loadPartials();
        renderTabla();

        // Nuevo: limpia campos incluyendo categoría
        $("#btnNuevo").on("click", ()=>{
            $("#prodId").val("");
            $("#prodNombre, #prodPrecio, #prodStock, #prodCategoria").val("");
            $("#prodImg").val("");
            currentImgData = "";
            $("#prodPreview").attr("src","").addClass("d-none");
            new bootstrap.Modal("#productoModal").show();
        });

        // Cargar imagen (si sube)
        $("#prodImg").on("change", async function(){
            const file = this.files[0];
            if(!file) return;
            if(!/image\/(png|jpeg|jpg)/i.test(file.type)){ alert("Sube JPG o PNG"); this.value=""; return; }
            try{
                const raw = await readFileAsDataURL(file);
                currentImgData = await compressImage(raw, 800, 'image/jpeg', 0.85);
                $("#prodPreview").attr("src", currentImgData).removeClass("d-none");
            }catch(e){ console.warn(e); alert("No se pudo leer la imagen."); }
        });

        // Guardar (crear o editar)
        $("#btnGuardarProd").on("click", (e)=>{
            e.preventDefault();

            // Validación simple
            const nombre = $("#prodNombre").val().trim();
            const precioRaw = $("#prodPrecio").val();
            const stockRaw = $("#prodStock").val();
            const categoriaRaw = $("#prodCategoria").val().trim();

            if(!nombre){ alert("El nombre es requerido."); return; }
            if(precioRaw === "" || isNaN(Number(precioRaw))){ alert("El precio es inválido."); return; }
            if(stockRaw === "" || isNaN(Number(stockRaw))){ alert("El stock es inválido."); return; }
            if(!categoriaRaw){ alert("La categoría es requerida."); return; }

            const precio = Number(precioRaw);
            const stock = Number(stockRaw);
            // Normalizamos la categoria: minúsculas y sin espacios extras
            const categoria = categoriaRaw.toLowerCase();

            const id = $("#prodId").val();
            const prods = getProds();

            if(id){
                // Editar: buscamos por id
                const idx = prods.findIndex(p=>String(p.id)===String(id));
                if(idx === -1){ alert("Producto no encontrado."); return; }
                prods[idx].nombre = nombre;
                prods[idx].precio = precio;
                prods[idx].stock  = stock;
                prods[idx].categoria = categoria; // <-- aquí aplico la categoría en la edición
                // solo reemplazamos la img si se subió una nueva
                if(currentImgData) prods[idx].img = currentImgData;
            }else{
                // Crear nuevo (incluye categoria)
                prods.push({
                    id: Date.now(),
                    nombre,
                    precio,
                    stock,
                    categoria, // <-- aquí aplico la categoría en la creación
                    img: currentImgData || ""
                });
            }

            saveProds(prods);
            renderTabla();
            bootstrap.Modal.getInstance(document.getElementById("productoModal")).hide();
            // reset preview/data
            currentImgData = "";
            $("#prodPreview").attr("src","").addClass("d-none");
        });

        // Editar: cargar valores al modal (incluida categoria)
        $(document).on("click",".editar",function(){
            const p = getProds().find(x=>String(x.id)===String($(this).data("id")));
            if(!p) return;
            $("#prodId").val(p.id);
            $("#prodNombre").val(p.nombre);
            $("#prodPrecio").val(p.precio);
            $("#prodStock").val(p.stock);
            // **Importante**: cargamos la categoria al input
            $("#prodCategoria").val(p.categoria || "");
            $("#prodImg").val("");
            currentImgData = ""; // no override a menos que suban nueva
            if(p.img){ $("#prodPreview").attr("src", p.img).removeClass("d-none"); }
            else { $("#prodPreview").attr("src","").addClass("d-none"); }
            new bootstrap.Modal("#productoModal").show();
        });

        // Eliminar
        $(document).on("click",".eliminar",function(){
            if(!confirm("¿Eliminar este producto?")) return;
            let prods = getProds().filter(x=>String(x.id)!==String($(this).data("id")));
            saveProds(prods);
            renderTabla();
        });
    });
</script>
</body>
</html>
